<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Academic Schedule Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Analytics Chart Styles */
        .chart-bar {
            height: 20px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .chart-bar:hover {
            transform: scaleX(1.02);
        }
        
        .chart-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        
        .timeline-item {
            padding: 12px;
            border-left: 3px solid var(--accent-primary);
            margin-bottom: 12px;
            background: var(--secondary-bg);
            border-radius: 0 8px 8px 0;
        }
        
        .timeline-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .timeline-content {
            font-size: 0.9rem;
        }
        
        /* Chat Modal Styles */
        .chat-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        
        .chat-modal-body {
            padding: 0;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        /* Responsive Grid */
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .analytics-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn glass" id="themeToggle">
            <i class="bi bi-sun-fill"></i>
        </button>
    </div>

    <!-- Navigation -->
    <nav class="navbar glass">
        <div class="navbar-container">
            <!-- Brand -->
            <a class="navbar-brand gradient-text" href="#">
                <div class="glass-icon" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));">
                    <i class="bi bi-calendar-check text-white"></i>
                </div>
                <span class="d-none d-md-inline">Admin Dashboard</span>
                <span class="d-inline d-md-none">Admin</span>
            </a>
            
            <!-- Mobile Toggle -->
            <button class="navbar-toggle" id="navbarToggle">
                <i class="bi bi-list"></i>
            </button>
            
            <!-- Menu -->
            <div class="navbar-collapse" id="navbarCollapse">
                <div class="navbar-user">
                    <div class="user-profile">
                        <div class="profile-picture" id="userProfilePicture">
                            <!-- Profile picture will be inserted by JavaScript -->
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="adminName">Loading...</div>
                            <div class="user-role">
                                <span class="badge badge-primary">ADMIN</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline btn-sm" id="logoutBtn">
                        <i class="bi bi-box-arrow-right me-1"></i> <span class="d-none d-md-inline">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Notification Area -->
    <div id="notificationArea"></div>

    <!-- Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass">
                <div class="chat-modal-header">
                    <i class="bi bi-chat-left-text"></i>
                    <h6 class="mb-0">Schedule Discussion</h6>
                </div>
                <div class="modal-body chat-modal-body">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Chat messages will be loaded here -->
                    </div>
                    <div class="chat-input-area">
                        <div class="input-group">
                            <input type="text" class="form-control glass-light" id="chatMessage" 
                                   placeholder="Type your message...">
                            <button class="btn btn-primary" id="sendMessageBtn">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <!-- Stats Overview -->
                <div class="stats-container">
                    <div class="stats-card glass hover-lift" id="totalSchedulesCard" onclick="filterSchedules('all')">
                        <div class="stats-value" id="totalSchedules">0</div>
                        <div class="stats-label">Total Schedules</div>
                    </div>
                    <div class="stats-card glass hover-lift" id="pendingCard" onclick="filterSchedules('pending')">
                        <div class="stats-value" id="pendingApprovals">0</div>
                        <div class="stats-label">Pending</div>
                    </div>
                    <div class="stats-card glass hover-lift" id="facultyCard" onclick="showFacultyList()">
                        <div class="stats-value" id="facultyCount">0</div>
                        <div class="stats-label">Faculty</div>
                    </div>
                </div>

                <!-- Create Schedule Form -->
                <div class="card glass hover-lift">
                    <div class="card-header">
                        <i class="bi bi-plus-circle gradient-text"></i>
                        Create New Schedule
                    </div>
                    <div class="card-body">
                        <form id="scheduleForm">
                            <div class="mb-3">
                                <label class="form-label">Faculty Email</label>
                                <input type="email" class="form-control glass-light" id="facultyEmail" required 
                                    placeholder="faculty@college.edu">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control glass-light" id="subject" required 
                                    placeholder="e.g., Data Structures">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Class/Group</label>
                                <input type="text" class="form-control glass-light" id="className" required 
                                    placeholder="e.g., CSE-A, 3rd Year">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control glass-light" id="scheduleDate" required>
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <label class="form-label">Start Time</label>
                                    <input type="time" class="form-control glass-light" id="startTime" required>
                                </div>
                                <div class="col">
                                    <label class="form-label">End Time</label>
                                    <input type="time" class="form-control glass-light" id="endTime" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-send me-2"></i> Create & Send Schedule
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Quick Analytics -->
                <div class="card glass hover-lift">
                    <div class="card-header">
                        <i class="bi bi-speedometer2 gradient-text"></i>
                        Quick Stats
                    </div>
                    <div class="card-body">
                        <div id="quickStats">
                            <div class="chart-label">
                                <span>Approval Rate</span>
                                <span id="approvalRate">0%</span>
                            </div>
                            <div class="chart-bar" style="width: 0%" id="approvalBar"></div>
                            
                            <div class="chart-label mt-3">
                                <span>Response Time</span>
                                <span id="responseTime">0h</span>
                            </div>
                            <div class="chart-bar" style="width: 0%" id="responseBar"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <ul class="nav nav-tabs" id="adminTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#allSchedules">
                            <i class="bi bi-list-ul me-2"></i> All Schedules
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#queries">
                            <i class="bi bi-question-circle me-2"></i> Faculty Queries
                            <span class="badge badge-warning ms-1" id="queryBadge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#analytics">
                            <i class="bi bi-bar-chart me-2"></i> Analytics
                        </a>
                    </li>
                </ul>

                <div class="tab-content mt-3">
                    <!-- All Schedules Tab -->
                    <div class="tab-pane fade show active" id="allSchedules">
                        <div class="card glass">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-calendar-week me-2 gradient-text"></i>All Schedules</h5>
                                <div class="d-flex gap-2">
                                    <input type="text" class="form-control form-control-sm glass-light" id="searchSchedule" 
                                           placeholder="Search schedules..." style="width: 200px;">
                                    <select class="form-select form-select-sm glass-light" id="statusFilter" style="width: 150px;">
                                        <option value="all">All Status</option>
                                        <option value="sent">Sent</option>
                                        <option value="delivered">Delivered</option>
                                        <option value="viewed">Viewed</option>
                                        <option value="approved">Approved</option>
                                        <option value="query_raised">Queries</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="schedulesContainer">
                                    <div class="text-center py-5">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-3 text-muted">Loading schedules...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Queries Tab -->
                    <div class="tab-pane fade" id="queries">
                        <div class="card glass">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-chat-left-text me-2 gradient-text"></i>Faculty Queries</h5>
                            </div>
                            <div class="card-body">
                                <div id="queriesContainer">
                                    <div class="text-center py-5">
                                        <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-warning), #d97706); margin: 0 auto;">
                                            <i class="bi bi-question-lg text-white"></i>
                                        </div>
                                        <h5 class="mb-2">No pending queries</h5>
                                        <p class="text-muted">All queries have been addressed</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div class="tab-pane fade" id="analytics">
                        <div class="analytics-container">
                            <!-- Status Distribution -->
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h6 class="mb-0">Schedule Status Distribution</h6>
                                    <select class="form-select form-select-sm glass-light" id="analyticsPeriod" style="width: 120px;">
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="year">This Year</option>
                                    </select>
                                </div>
                                <div class="chart-container">
                                    <div id="statusChart" class="chart-placeholder">
                                        <i class="bi bi-pie-chart display-4 text-muted"></i>
                                        <p class="mt-2">Loading chart data...</p>
                                    </div>
                                </div>
                                <div class="chart-legend" id="statusLegend"></div>
                            </div>

                            <!-- Activity Timeline -->
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h6 class="mb-0">Recent Activity</h6>
                                    <button class="btn btn-sm btn-outline" onclick="refreshAnalytics()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <div class="chart-container">
                                    <div id="activityTimeline" style="height: 250px; overflow-y: auto;">
                                        <div class="text-center py-5">
                                            <div class="loading-spinner"></div>
                                            <p class="mt-2 text-muted">Loading activity...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase and Admin JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            onSnapshot, 
            updateDoc, 
            doc, 
            getDoc, 
            setDoc,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALXM9g6HkFHuHLYNXjZ417_9d6bkPGatc",
            authDomain: "tracker-pts.firebaseapp.com",
            projectId: "tracker-pts",
            storageBucket: "tracker-pts.firebasestorage.app",
            messagingSenderId: "237919442573",
            appId: "1:237919442573:web:e3abad42a0a1f49f5334c4",
            measurementId: "G-R5K7KNKMYS"
        };

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        const currentTheme = localStorage.getItem('theme') || (prefersDark.matches ? 'dark' : 'light');
        
        if (currentTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            themeIcon.className = 'bi bi-moon-fill';
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            themeIcon.className = 'bi bi-sun-fill';
        }
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (currentTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                themeIcon.className = 'bi bi-moon-fill';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                themeIcon.className = 'bi bi-sun-fill';
            }
        });

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check if user is admin
        if (localStorage.getItem('userRole') !== 'admin') {
            showNotification('Access denied. Admins only.', 'danger');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }

        // Mobile Navigation Toggle
        const navbarToggle = document.getElementById('navbarToggle');
        const navbarCollapse = document.getElementById('navbarCollapse');
        
        navbarToggle.addEventListener('click', () => {
            navbarCollapse.classList.toggle('show');
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (event) => {
            if (!navbarToggle.contains(event.target) && !navbarCollapse.contains(event.target)) {
                navbarCollapse.classList.remove('show');
            }
        });

        // Set user profile
        function setUserProfile() {
            const adminName = localStorage.getItem('userName') || 'Admin';
            const userPhoto = localStorage.getItem('userPhoto') || '';
            const profilePicture = document.getElementById('userProfilePicture');
            const nameElement = document.getElementById('adminName');
            
            nameElement.textContent = adminName;
            
            if (userPhoto) {
                profilePicture.innerHTML = `<img src="${userPhoto}" alt="${adminName}" onerror="this.parentElement.className='profile-picture fallback'; this.parentElement.innerHTML='${adminName.charAt(0)}'">`;
            } else {
                profilePicture.className = 'profile-picture fallback';
                profilePicture.textContent = adminName.charAt(0).toUpperCase();
            }
        }

        setUserProfile();

        // Show notification
        function showNotification(message, type = 'info', duration = 5000) {
            const notificationArea = document.getElementById('notificationArea');
            const notificationId = 'notification-' + Date.now();
            
            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = `notification fade-in`;
            notification.innerHTML = `
                <div class="glass-icon" style="${getNotificationColor(type)}">
                    <i class="bi ${getNotificationIcon(type)} text-white"></i>
                </div>
                <div class="flex-grow-1">
                    <p class="mb-0">${message}</p>
                </div>
                <button type="button" class="btn-close" onclick="document.getElementById('${notificationId}').remove()"></button>
            `;
            
            if (!notificationArea) {
                const newNotificationArea = document.createElement('div');
                newNotificationArea.id = 'notificationArea';
                document.body.appendChild(newNotificationArea);
            }
            
            document.getElementById('notificationArea').appendChild(notification);
            
            // Auto remove after duration
            setTimeout(() => {
                const notif = document.getElementById(notificationId);
                if (notif) notif.remove();
            }, duration);
        }

        function getNotificationColor(type) {
            switch(type) {
                case 'success': return 'background: linear-gradient(135deg, var(--accent-success), #059669);';
                case 'warning': return 'background: linear-gradient(135deg, var(--accent-warning), #d97706);';
                case 'danger': return 'background: linear-gradient(135deg, var(--accent-danger), #dc2626);';
                default: return 'background: linear-gradient(135deg, var(--accent-info), #2563eb);';
            }
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'bi-check-circle-fill';
                case 'warning': return 'bi-exclamation-triangle-fill';
                case 'danger': return 'bi-x-circle-fill';
                default: return 'bi-info-circle-fill';
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Logout error:", error);
                showNotification('Logout failed', 'danger');
            }
        });

        // Global variables
        let allSchedules = [];
        let activeFilter = 'all';
        let currentChatScheduleId = null;
        const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));

        // Clickable Stats Cards
        function filterSchedules(filter) {
            activeFilter = filter;
            
            // Update active card
            document.querySelectorAll('.stats-card').forEach(card => {
                card.classList.remove('active', 'pulse');
            });
            
            switch(filter) {
                case 'all':
                    document.getElementById('totalSchedulesCard').classList.add('active', 'pulse');
                    document.getElementById('statusFilter').value = 'all';
                    break;
                case 'pending':
                    document.getElementById('pendingCard').classList.add('active', 'pulse');
                    document.getElementById('statusFilter').value = 'pending';
                    break;
            }
            
            loadFilteredSchedules();
        }

        function showFacultyList() {
            document.getElementById('adminTabs').querySelector('[href="#allSchedules"]').click();
            document.getElementById('searchSchedule').value = '';
            document.getElementById('statusFilter').value = 'all';
            loadFilteredSchedules();
            showNotification('Showing all faculty schedules', 'info');
        }

        // Load filtered schedules
        function loadFilteredSchedules() {
            const searchTerm = document.getElementById('searchSchedule')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            
            const container = document.getElementById('schedulesContainer');
            container.innerHTML = '';
            
            if (allSchedules.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); margin: 0 auto;">
                            <i class="bi bi-calendar-x text-white"></i>
                        </div>
                        <h5 class="mb-2">No schedules found</h5>
                        <p class="text-muted">Create your first schedule to get started</p>
                    </div>
                `;
                return;
            }
            
            let filteredSchedules = allSchedules.filter(schedule => {
                // Apply search filter
                if (searchTerm && !(
                    schedule.subject.toLowerCase().includes(searchTerm) ||
                    schedule.className.toLowerCase().includes(searchTerm) ||
                    schedule.facultyName.toLowerCase().includes(searchTerm) ||
                    schedule.facultyEmail.toLowerCase().includes(searchTerm)
                )) {
                    return false;
                }
                
                // Apply status filter
                if (statusFilter === 'pending') {
                    return ['sent', 'delivered', 'viewed', 'query_raised'].includes(schedule.status);
                } else if (statusFilter !== 'all') {
                    return schedule.status === statusFilter;
                }
                
                return true;
            });
            
            if (filteredSchedules.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-info), #2563eb); margin: 0 auto;">
                            <i class="bi bi-search text-white"></i>
                        </div>
                        <h5 class="mb-2">No matching schedules found</h5>
                        <p class="text-muted">Try changing your search or filter</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date and time
            filteredSchedules.sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                return b.startTime.localeCompare(a.startTime);
            });
            
            filteredSchedules.forEach(schedule => {
                const scheduleDiv = createScheduleCard(schedule);
                container.appendChild(scheduleDiv);
            });
        }

        // Create schedule card with chat button
        function createScheduleCard(schedule) {
            const scheduleDiv = document.createElement('div');
            scheduleDiv.className = `schedule-card glass fade-in ${schedule.status === 'approved' ? 'approved' : ''} ${schedule.status === 'query_raised' ? 'query' : ''}`;
            
            const statusInfo = {
                sent: { icon: 'üì§', text: 'Sent', color: 'badge-sent' },
                delivered: { icon: 'üì•', text: 'Delivered', color: 'badge-delivered' },
                viewed: { icon: 'üëÅÔ∏è', text: 'Viewed', color: 'badge-viewed' },
                approved: { icon: '‚úÖ', text: 'Approved', color: 'badge-approved' },
                query_raised: { icon: '‚ùì', text: 'Query Raised', color: 'badge-query_raised' }
            };
            
            const status = statusInfo[schedule.status] || { icon: '', text: schedule.status, color: 'badge-sent' };
            
            scheduleDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div style="flex: 1;">
                        <h6 class="mb-2 gradient-text">${schedule.subject}</h6>
                        <p class="mb-1"><strong>Class:</strong> ${schedule.className}</p>
                        <p class="mb-1"><strong>Faculty:</strong> ${schedule.facultyName} <small class="text-muted">(${schedule.facultyEmail})</small></p>
                        <p class="mb-1"><strong>Date:</strong> ${schedule.date}</p>
                        <p class="mb-1">
                            <strong>Time:</strong> 
                            <span class="time-display ms-1">${schedule.startTime} - ${schedule.endTime}</span>
                        </p>
                        <p class="mb-0">
                            <strong>Status:</strong> 
                            <span class="badge ${status.color} ms-2">
                                ${status.icon} ${status.text}
                            </span>
                        </p>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">Created: ${new Date(schedule.createdAt).toLocaleDateString()}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline" onclick="openChat('${schedule.id}')">
                                <i class="bi bi-chat-left"></i> Chat
                            </button>
                        </div>
                    </div>
                </div>
                ${schedule.queries && schedule.queries.length > 0 ? `
                    <div class="mt-3 border-top pt-3">
                        <h6><i class="bi bi-chat-left-text me-2 gradient-text"></i>Discussion</h6>
                        <div class="mt-2">
                            ${schedule.queries.slice(-2).map((q, index) => `
                                <div class="query-bubble ${q.sender === 'faculty' ? 'faculty' : 'admin'} mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <strong>${q.sender === 'faculty' ? schedule.facultyName : 'You (Admin)'}</strong>
                                        <small class="text-muted">${new Date(q.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                                    </div>
                                    <div>${q.message}</div>
                                    <div class="text-end mt-1">
                                        <small class="text-muted">${new Date(q.timestamp).toLocaleDateString()}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            return scheduleDiv;
        }

        // Open chat for a schedule
        window.openChat = async function(scheduleId) {
            currentChatScheduleId = scheduleId;
            const schedule = allSchedules.find(s => s.id === scheduleId);
            
            if (!schedule) return;
            
            document.getElementById('chatMessages').innerHTML = `
                <div class="text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="mt-2 text-muted">Loading chat...</p>
                </div>
            `;
            
            // Load chat messages
            setTimeout(() => {
                loadChatMessages(schedule);
            }, 500);
            
            chatModal.show();
        };

        function loadChatMessages(schedule) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (!schedule.queries || schedule.queries.length === 0) {
                chatMessages.innerHTML = `
                    <div class="text-center py-5">
                        <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-info), #2563eb); margin: 0 auto;">
                            <i class="bi bi-chat-left-text text-white"></i>
                        </div>
                        <h6 class="mb-2">Start a conversation</h6>
                        <p class="text-muted">No messages yet. Send the first message!</p>
                    </div>
                `;
                return;
            }
            
            schedule.queries.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender === 'admin' ? 'sent' : 'received'} fade-in`;
                messageDiv.style.animationDelay = `${index * 0.1}s`;
                
                const senderName = message.sender === 'admin' ? 'You (Admin)' : schedule.facultyName;
                const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${senderName}</div>
                    <div class="message-content">${message.message}</div>
                    <div class="message-time">${time}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send chat message
        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            const messageInput = document.getElementById('chatMessage');
            const message = messageInput.value.trim();
            
            if (!message || !currentChatScheduleId) return;
            
            try {
                const scheduleRef = doc(db, 'schedules', currentChatScheduleId);
                const scheduleDoc = await getDoc(scheduleRef);
                const schedule = scheduleDoc.data();
                
                const queries = schedule.queries || [];
                queries.push({
                    message: message,
                    sender: 'admin',
                    timestamp: new Date().toISOString()
                });
                
                await updateDoc(scheduleRef, {
                    queries: queries,
                    status: schedule.status === 'query_raised' ? 'viewed' : schedule.status,
                    updatedAt: new Date().toISOString()
                });
                
                messageInput.value = '';
                
                // Reload chat
                const updatedSchedule = allSchedules.find(s => s.id === currentChatScheduleId);
                if (updatedSchedule) {
                    updatedSchedule.queries = queries;
                    loadChatMessages(updatedSchedule);
                }
                
            } catch (error) {
                console.error("Error sending message:", error);
                showNotification('Failed to send message', 'danger');
            }
        });

        // Load all schedules
        function loadAllSchedules() {
            const q = collection(db, 'schedules');
            
            onSnapshot(q, (snapshot) => {
                allSchedules = [];
                let totalSchedules = 0;
                let pendingApprovals = 0;
                let facultyCount = 0;
                let queriesCount = 0;
                
                snapshot.forEach((doc) => {
                    const schedule = { id: doc.id, ...doc.data() };
                    allSchedules.push(schedule);
                    totalSchedules++;
                    
                    if (['sent', 'delivered', 'viewed', 'query_raised'].includes(schedule.status)) {
                        pendingApprovals++;
                    }
                    
                    if (schedule.status === 'query_raised') {
                        queriesCount++;
                    }
                });
                
                // Update stats
                document.getElementById('totalSchedules').textContent = totalSchedules;
                document.getElementById('pendingApprovals').textContent = pendingApprovals;
                document.getElementById('queryBadge').textContent = queriesCount;
                document.getElementById('queryBadge').style.display = queriesCount > 0 ? 'inline-block' : 'none';
                
                // Update filtered view
                loadFilteredSchedules();
                
                // Update analytics
                updateAnalytics(allSchedules);
                
            }, (error) => {
                console.error("Error loading schedules:", error);
                showNotification('Error loading schedules: ' + error.message, 'danger');
            });
        }

        // Load faculty count
        async function loadFacultyCount() {
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                let facultyCount = 0;
                
                usersSnapshot.forEach((userDoc) => {
                    const user = userDoc.data();
                    if (user.role === 'faculty') {
                        facultyCount++;
                    }
                });
                
                document.getElementById('facultyCount').textContent = facultyCount;
            } catch (error) {
                console.error("Error loading faculty count:", error);
            }
        }

        // Analytics functions
        function updateAnalytics(schedules) {
            if (!schedules || schedules.length === 0) {
                updateEmptyAnalytics();
                return;
            }
            
            // Calculate approval rate
            const approvedCount = schedules.filter(s => s.status === 'approved').length;
            const totalCount = schedules.length;
            const approvalRate = totalCount > 0 ? Math.round((approvedCount / totalCount) * 100) : 0;
            
            document.getElementById('approvalRate').textContent = `${approvalRate}%`;
            document.getElementById('approvalBar').style.width = `${approvalRate}%`;
            
            // Calculate average response time (simplified)
            let totalResponseTime = 0;
            let responseCount = 0;
            
            schedules.forEach(schedule => {
                if (schedule.queries && schedule.queries.length >= 2) {
                    const firstQuery = new Date(schedule.queries[0].timestamp);
                    const lastResponse = new Date(schedule.queries[schedule.queries.length - 1].timestamp);
                    const responseTime = (lastResponse - firstQuery) / (1000 * 60 * 60); // in hours
                    totalResponseTime += responseTime;
                    responseCount++;
                }
            });
            
            const avgResponseTime = responseCount > 0 ? Math.round(totalResponseTime / responseCount) : 0;
            document.getElementById('responseTime').textContent = `${avgResponseTime}h`;
            document.getElementById('responseBar').style.width = `${Math.min(avgResponseTime * 10, 100)}%`;
            
            // Update status chart
            updateStatusChart(schedules);
            
            // Update activity timeline
            updateActivityTimeline(schedules);
        }

        function updateStatusChart(schedules) {
            const statusCounts = {
                sent: 0,
                delivered: 0,
                viewed: 0,
                approved: 0,
                query_raised: 0
            };
            
            schedules.forEach(schedule => {
                if (statusCounts[schedule.status] !== undefined) {
                    statusCounts[schedule.status]++;
                }
            });
            
            const total = schedules.length;
            const chartContainer = document.getElementById('statusChart');
            const legendContainer = document.getElementById('statusLegend');
            
            if (total === 0) {
                chartContainer.innerHTML = `
                    <i class="bi bi-pie-chart display-4 text-muted"></i>
                    <p class="mt-2">No data available</p>
                `;
                legendContainer.innerHTML = '';
                return;
            }
            
            // Create simple bar chart
            let chartHTML = '';
            let legendHTML = '';
            
            const colors = {
                sent: '#6b7280',
                delivered: '#0ea5e9',
                viewed: '#3b82f6',
                approved: '#10b981',
                query_raised: '#f59e0b'
            };
            
            const labels = {
                sent: 'Sent',
                delivered: 'Delivered',
                viewed: 'Viewed',
                approved: 'Approved',
                query_raised: 'Queries'
            };
            
            Object.entries(statusCounts).forEach(([status, count]) => {
                if (count > 0) {
                    const percentage = Math.round((count / total) * 100);
                    chartHTML += `
                        <div class="chart-label">
                            <span>${labels[status]}</span>
                            <span>${count} (${percentage}%)</span>
                        </div>
                        <div class="chart-bar" style="width: ${percentage}%; background: linear-gradient(90deg, ${colors[status]}, ${colors[status]}99);"></div>
                    `;
                    
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${colors[status]}"></div>
                            <span>${labels[status]}</span>
                        </div>
                    `;
                }
            });
            
            chartContainer.innerHTML = chartHTML || '<p class="text-muted">No status data</p>';
            legendContainer.innerHTML = legendHTML;
        }

        function updateActivityTimeline(schedules) {
            const timeline = document.getElementById('activityTimeline');
            const recentActivities = [];
            
            // Get recent activities from schedules
            schedules.forEach(schedule => {
                if (schedule.updatedAt) {
                    recentActivities.push({
                        time: new Date(schedule.updatedAt),
                        content: `${schedule.facultyName} - ${schedule.subject}`,
                        status: schedule.status,
                        type: 'schedule_update'
                    });
                }
                
                // Add query activities
                if (schedule.queries) {
                    schedule.queries.forEach(query => {
                        recentActivities.push({
                            time: new Date(query.timestamp),
                            content: `${query.sender === 'faculty' ? schedule.facultyName : 'Admin'}: ${query.message.substring(0, 50)}...`,
                            status: 'chat',
                            type: 'chat_message'
                        });
                    });
                }
            });
            
            // Sort by time (newest first) and take last 10
            recentActivities.sort((a, b) => b.time - a.time);
            const recent = recentActivities.slice(0, 10);
            
            if (recent.length === 0) {
                timeline.innerHTML = `
                    <div class="text-center py-5">
                        <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-info), #2563eb); margin: 0 auto;">
                            <i class="bi bi-clock-history text-white"></i>
                        </div>
                        <h6 class="mb-2">No recent activity</h6>
                        <p class="text-muted">Activity will appear here</p>
                    </div>
                `;
                return;
            }
            
            let timelineHTML = '';
            recent.forEach(activity => {
                const timeAgo = getTimeAgo(activity.time);
                const icon = activity.type === 'chat_message' ? 'bi-chat-left' : 'bi-calendar-check';
                
                timelineHTML += `
                    <div class="timeline-item">
                        <div class="timeline-time">
                            <i class="bi ${icon} me-1"></i> ${timeAgo}
                        </div>
                        <div class="timeline-content">${activity.content}</div>
                    </div>
                `;
            });
            
            timeline.innerHTML = timelineHTML;
        }

        function updateEmptyAnalytics() {
            document.getElementById('approvalRate').textContent = '0%';
            document.getElementById('approvalBar').style.width = '0%';
            document.getElementById('responseTime').textContent = '0h';
            document.getElementById('responseBar').style.width = '0%';
            
            document.getElementById('statusChart').innerHTML = `
                <i class="bi bi-pie-chart display-4 text-muted"></i>
                <p class="mt-2">No data available</p>
            `;
            
            document.getElementById('statusLegend').innerHTML = '';
            
            document.getElementById('activityTimeline').innerHTML = `
                <div class="text-center py-5">
                    <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-info), #2563eb); margin: 0 auto;">
                        <i class="bi bi-clock-history text-white"></i>
                    </div>
                    <h6 class="mb-2">No recent activity</h6>
                    <p class="text-muted">Activity will appear here</p>
                </div>
            `;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return "just now";
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }

        // Refresh analytics
        window.refreshAnalytics = function() {
            updateAnalytics(allSchedules);
            showNotification('Analytics refreshed', 'info', 2000);
        };

        // Create schedule
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const facultyEmail = document.getElementById('facultyEmail').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const className = document.getElementById('className').value.trim();
            const scheduleDate = document.getElementById('scheduleDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            // Validation
            if (!facultyEmail || !subject || !className || !scheduleDate || !startTime || !endTime) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            if (startTime >= endTime) {
                showNotification('End time must be after start time', 'warning');
                return;
            }
            
            try {
                const usersSnapshot = await getDocs(query(collection(db, 'users'), where('email', '==', facultyEmail)));
                if (usersSnapshot.empty) {
                    showNotification('Faculty not found. Please check the email address.', 'warning');
                    return;
                }
                
                const facultyUser = usersSnapshot.docs[0].data();
                const facultyId = usersSnapshot.docs[0].id;
                
                // Check for duplicate schedule
                const existingSchedules = await getDocs(query(
                    collection(db, 'schedules'),
                    where('facultyId', '==', facultyId),
                    where('date', '==', scheduleDate),
                    where('startTime', '==', startTime)
                ));
                
                if (!existingSchedules.empty) {
                    showNotification('A schedule already exists for this faculty at the same time', 'warning');
                    return;
                }
                
                const scheduleData = {
                    facultyEmail: facultyEmail,
                    facultyName: facultyUser.name,
                    facultyId: facultyId,
                    subject: subject,
                    className: className,
                    date: scheduleDate,
                    startTime: startTime,
                    endTime: endTime,
                    status: 'sent',
                    createdBy: auth.currentUser.uid,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    queries: []
                };
                
                await addDoc(collection(db, 'schedules'), scheduleData);
                
                // Reset form
                document.getElementById('scheduleForm').reset();
                
                // Set default date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('scheduleDate').valueAsDate = tomorrow;
                
                showNotification('Schedule created and sent successfully!', 'success');
                
            } catch (error) {
                console.error("Error creating schedule:", error);
                showNotification('Failed to create schedule: ' + error.message, 'danger');
            }
        });

        // Search and filter events
        document.getElementById('searchSchedule')?.addEventListener('input', loadFilteredSchedules);
        document.getElementById('statusFilter')?.addEventListener('change', loadFilteredSchedules);
        document.getElementById('analyticsPeriod')?.addEventListener('change', () => {
            updateAnalytics(allSchedules);
        });

        // Initialize
        loadAllSchedules();
        loadFacultyCount();

        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('scheduleDate').valueAsDate = tomorrow;
        
        // Set default time to next hour
        const nextHour = new Date();
        nextHour.setHours(nextHour.getHours() + 1);
        const startTimeStr = nextHour.toTimeString().substring(0, 5);
        document.getElementById('startTime').value = startTimeStr;
        
        nextHour.setHours(nextHour.getHours() + 1);
        const endTimeStr = nextHour.toTimeString().substring(0, 5);
        document.getElementById('endTime').value = endTimeStr;
    </script>
</body>
</html>
