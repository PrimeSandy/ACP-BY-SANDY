<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Academic Schedule Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-calendar-check me-2"></i> Admin Dashboard
            </a>
            <div class="d-flex align-items-center">
                <span class="user-badge text-dark me-3">
                    <i class="bi bi-person-fill me-1"></i> <span id="adminName">Loading...</span>
                </span>
                <button class="btn btn-outline-light btn-sm" id="logoutBtn">
                    <i class="bi bi-box-arrow-right me-1"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Notification Area -->
    <div id="notificationArea"></div>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-plus-circle me-2"></i> Create New Schedule
                    </div>
                    <div class="card-body">
                        <form id="scheduleForm">
                            <div class="mb-3">
                                <label class="form-label">Faculty Email</label>
                                <input type="email" class="form-control" id="facultyEmail" required 
                                    placeholder="faculty@college.edu">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control" id="subject" required 
                                    placeholder="e.g., Data Structures">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Class/Group</label>
                                <input type="text" class="form-control" id="className" required 
                                    placeholder="e.g., CSE-A, 3rd Year">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="scheduleDate" required>
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <label class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="startTime" required>
                                </div>
                                <div class="col">
                                    <label class="form-label">End Time</label>
                                    <input type="time" class="form-control" id="endTime" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-send me-2"></i> Create & Send Schedule
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-people me-2"></i> User Management
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="searchUser" 
                                placeholder="Search by name or email">
                        </div>
                        <div id="usersList" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <ul class="nav nav-tabs" id="adminTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#allSchedules">
                            <i class="bi bi-list-ul me-2"></i> All Schedules
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#queries">
                            <i class="bi bi-question-circle me-2"></i> Faculty Queries
                            <span class="badge bg-danger ms-1" id="queryBadge">0</span>
                        </a>
                    </li>
                </ul>

                <div class="tab-content mt-3">
                    <!-- All Schedules Tab -->
                    <div class="tab-pane fade show active" id="allSchedules">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">All Schedules</h5>
                                <select class="form-select form-select-sm w-auto" id="statusFilter">
                                    <option value="all">All Status</option>
                                    <option value="sent">Sent</option>
                                    <option value="delivered">Delivered</option>
                                    <option value="viewed">Viewed</option>
                                    <option value="approved">Approved</option>
                                    <option value="query_raised">Queries</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div id="schedulesContainer">
                                    <div class="text-center py-5">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading schedules...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Queries Tab -->
                    <div class="tab-pane fade" id="queries">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Faculty Queries</h5>
                            </div>
                            <div class="card-body">
                                <div id="queriesContainer">
                                    <div class="text-center py-5">
                                        <p class="text-muted">No pending queries</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase and Admin JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, updateDoc, doc, getDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALXM9g6HkFHuHLYNXjZ417_9d6bkPGatc",
            authDomain: "tracker-pts.firebaseapp.com",
            projectId: "tracker-pts",
            storageBucket: "tracker-pts.firebasestorage.app",
            messagingSenderId: "237919442573",
            appId: "1:237919442573:web:e3abad42a0a1f49f5334c4",
            measurementId: "G-R5K7KNKMYS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check if user is admin
        if (localStorage.getItem('userRole') !== 'admin') {
            alert('Access denied. Admins only.');
            window.location.href = 'index.html';
        }

        // Set admin name
        document.getElementById('adminName').textContent = localStorage.getItem('userName') || 'Admin';

        // Show notification
        function showNotification(message, type = 'info', duration = 5000) {
            const notificationArea = document.getElementById('notificationArea');
            const notificationId = 'notification-' + Date.now();
            
            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = `alert alert-${type} alert-dismissible fade show global-notification`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="document.getElementById('${notificationId}').remove()"></button>
            `;
            
            notificationArea.appendChild(notification);
            
            // Auto remove after duration
            setTimeout(() => {
                const notif = document.getElementById(notificationId);
                if (notif) notif.remove();
            }, duration);
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Logout error:", error);
                showNotification('Logout failed', 'danger');
            }
        });

        // Load users
        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';
            
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                usersList.innerHTML = '';
                
                if (usersSnapshot.empty) {
                    usersList.innerHTML = '<div class="text-center py-3 text-muted">No users found</div>';
                    return;
                }
                
                usersSnapshot.forEach((userDoc) => {
                    const user = userDoc.data();
                    const userDiv = document.createElement('div');
                    userDiv.className = 'd-flex justify-content-between align-items-center p-2 border-bottom';
                    userDiv.innerHTML = `
                        <div class="text-truncate" style="max-width: 200px;">
                            <strong class="d-block">${user.name || 'No name'}</strong>
                            <small class="text-muted d-block">${user.email}</small>
                            <span class="badge bg-${user.role === 'admin' ? 'primary' : 'success'}">
                                ${user.role}
                            </span>
                        </div>
                        <select class="form-select form-select-sm role-select" data-uid="${userDoc.id}" style="width: 110px;">
                            <option value="faculty" ${user.role === 'faculty' ? 'selected' : ''}>Faculty</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    `;
                    usersList.appendChild(userDiv);
                });
                
                // Add event listeners to role selects
                document.querySelectorAll('.role-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const uid = e.target.dataset.uid;
                        const newRole = e.target.value;
                        
                        // Prevent removing last admin
                        if (newRole === 'faculty') {
                            const adminUsers = await getDocs(query(collection(db, 'users'), where('role', '==', 'admin')));
                            if (adminUsers.size <= 1) {
                                showNotification('Cannot change role: At least one admin must exist.', 'warning');
                                e.target.value = 'admin';
                                return;
                            }
                        }
                        
                        try {
                            await updateDoc(doc(db, 'users', uid), { role: newRole });
                            showNotification('User role updated successfully', 'success');
                        } catch (error) {
                            console.error("Error updating role:", error);
                            showNotification('Failed to update role', 'danger');
                        }
                    });
                });
            } catch (error) {
                console.error("Error loading users:", error);
                usersList.innerHTML = '<div class="text-center py-3 text-danger">Error loading users</div>';
            }
        }

        // Create schedule
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const facultyEmail = document.getElementById('facultyEmail').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const className = document.getElementById('className').value.trim();
            const scheduleDate = document.getElementById('scheduleDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            // Validation
            if (startTime >= endTime) {
                showNotification('End time must be after start time', 'warning');
                return;
            }
            
            // Get faculty user by email
            try {
                const usersSnapshot = await getDocs(query(collection(db, 'users'), where('email', '==', facultyEmail)));
                if (usersSnapshot.empty) {
                    showNotification('Faculty not found. Please check the email address.', 'warning');
                    return;
                }
                
                const facultyUser = usersSnapshot.docs[0].data();
                const facultyId = usersSnapshot.docs[0].id;
                
                // Check for duplicate schedule (same faculty, date, and overlapping time)
                const existingSchedules = await getDocs(query(
                    collection(db, 'schedules'),
                    where('facultyId', '==', facultyId),
                    where('date', '==', scheduleDate)
                ));
                
                let hasConflict = false;
                existingSchedules.forEach(doc => {
                    const schedule = doc.data();
                    // Check for time overlap
                    if ((startTime >= schedule.startTime && startTime < schedule.endTime) ||
                        (endTime > schedule.startTime && endTime <= schedule.endTime) ||
                        (startTime <= schedule.startTime && endTime >= schedule.endTime)) {
                        hasConflict = true;
                    }
                });
                
                if (hasConflict) {
                    showNotification('This faculty already has a schedule at the same time on this date', 'warning');
                    return;
                }
                
                const scheduleData = {
                    facultyEmail: facultyEmail,
                    facultyName: facultyUser.name,
                    facultyId: facultyId,
                    subject: subject,
                    className: className,
                    date: scheduleDate,
                    startTime: startTime,
                    endTime: endTime,
                    status: 'sent',
                    createdBy: auth.currentUser.uid,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    queries: []
                };
                
                await addDoc(collection(db, 'schedules'), scheduleData);
                
                // Reset form
                document.getElementById('scheduleForm').reset();
                
                // Set default date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('scheduleDate').valueAsDate = tomorrow;
                
                showNotification('Schedule created and sent successfully!', 'success');
                
            } catch (error) {
                console.error("Error creating schedule:", error);
                showNotification('Failed to create schedule: ' + error.message, 'danger');
            }
        });

        // Load schedules
        let unsubscribeSchedules;
        function loadSchedules(filterStatus = 'all') {
            const container = document.getElementById('schedulesContainer');
            
            if (unsubscribeSchedules) unsubscribeSchedules();
            
            let q = query(collection(db, 'schedules'), orderBy('date', 'desc'), orderBy('startTime', 'desc'));
            
            unsubscribeSchedules = onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="text-center py-5"><p class="text-muted">No schedules found</p></div>';
                    return;
                }
                
                // Status counts
                const statusCounts = { all: 0, sent: 0, delivered: 0, viewed: 0, approved: 0, query_raised: 0 };
                
                snapshot.docs.forEach((doc) => {
                    const schedule = { id: doc.id, ...doc.data() };
                    statusCounts.all++;
                    if (statusCounts[schedule.status] !== undefined) {
                        statusCounts[schedule.status]++;
                    }
                    
                    // Apply filter
                    if (filterStatus !== 'all' && schedule.status !== filterStatus) {
                        return;
                    }
                    
                    const scheduleDiv = document.createElement('div');
                    scheduleDiv.className = `schedule-card card p-3 mb-3 fade-in ${schedule.status === 'approved' ? 'approved' : ''} ${schedule.status === 'query_raised' ? 'query' : ''}`;
                    
                    // Status icons
                    const statusIcons = {
                        sent: 'üì§',
                        delivered: 'üì•',
                        viewed: 'üëÅÔ∏è',
                        approved: '‚úÖ',
                        query_raised: '‚ùì'
                    };
                    
                    scheduleDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <h6 class="mb-2">${schedule.subject}</h6>
                                <p class="mb-1"><strong>Class:</strong> ${schedule.className}</p>
                                <p class="mb-1"><strong>Faculty:</strong> ${schedule.facultyName} <small class="text-muted">(${schedule.facultyEmail})</small></p>
                                <p class="mb-1"><strong>Date:</strong> ${schedule.date}</p>
                                <p class="mb-1">
                                    <strong>Time:</strong> 
                                    <span class="time-display ms-1">${schedule.startTime} - ${schedule.endTime}</span>
                                </p>
                                <p class="mb-0">
                                    <strong>Status:</strong> 
                                    <span class="badge bg-${schedule.status.replace('_', '')} ms-2">
                                        ${statusIcons[schedule.status] || ''} ${schedule.status.replace('_', ' ')}
                                    </span>
                                </p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Created: ${new Date(schedule.createdAt).toLocaleDateString()}</small>
                            </div>
                        </div>
                        ${schedule.queries && schedule.queries.length > 0 ? `
                            <div class="mt-3 border-top pt-3">
                                <h6><i class="bi bi-chat-left-text me-2"></i>Discussion</h6>
                                <div class="mt-2">
                                    ${schedule.queries.map((q, index) => `
                                        <div class="query-bubble ${q.sender === 'faculty' ? 'faculty' : 'admin'} mb-2">
                                            <div class="d-flex justify-content-between mb-1">
                                                <strong>${q.sender === 'faculty' ? schedule.facultyName : 'You (Admin)'}</strong>
                                                <small class="text-muted">${new Date(q.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                                            </div>
                                            <div>${q.message}</div>
                                            <div class="text-end mt-1">
                                                <small class="text-muted">${new Date(q.timestamp).toLocaleDateString()}</small>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${schedule.status === 'query_raised' ? `
                                    <div class="mt-2">
                                        <div class="input-group">
                                            <textarea class="form-control" id="response-${schedule.id}" 
                                                    placeholder="Type your response..." rows="2"></textarea>
                                            <button class="btn btn-primary" onclick="sendResponse('${schedule.id}')">
                                                <i class="bi bi-send"></i> Reply
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    `;
                    
                    container.appendChild(scheduleDiv);
                });
                
                // Update dropdown with counts
                updateStatusDropdown(statusCounts);
                
            }, (error) => {
                console.error("Error loading schedules:", error);
                container.innerHTML = '<div class="text-center py-5"><p class="text-danger">Error loading schedules</p></div>';
            });
        }

        // Update status dropdown with counts
        function updateStatusDropdown(counts) {
            const statusFilter = document.getElementById('statusFilter');
            if (!statusFilter) return;
            
            statusFilter.innerHTML = `
                <option value="all">All Schedules (${counts.all})</option>
                <option value="sent">Sent (${counts.sent})</option>
                <option value="delivered">Delivered (${counts.delivered})</option>
                <option value="viewed">Viewed (${counts.viewed})</option>
                <option value="approved">Approved (${counts.approved})</option>
                <option value="query_raised">Queries (${counts.query_raised})</option>
            `;
            
            // Restore selected value
            statusFilter.addEventListener('change', (e) => {
                loadSchedules(e.target.value);
            });
        }

        // Send response to query
        window.sendResponse = async function(scheduleId) {
            const responseText = document.getElementById(`response-${scheduleId}`)?.value?.trim();
            if (!responseText) return;
            
            try {
                const scheduleRef = doc(db, 'schedules', scheduleId);
                const scheduleDoc = await getDoc(scheduleRef);
                const schedule = scheduleDoc.data();
                
                const queries = schedule.queries || [];
                queries.push({
                    message: responseText,
                    sender: 'admin',
                    timestamp: new Date().toISOString()
                });
                
                await updateDoc(scheduleRef, {
                    queries: queries,
                    status: 'viewed',
                    updatedAt: new Date().toISOString()
                });
                
                document.getElementById(`response-${scheduleId}`).value = '';
                showNotification('Response sent successfully', 'success');
            } catch (error) {
                console.error("Error sending response:", error);
                showNotification('Failed to send response', 'danger');
            }
        };

        // Load queries count
        function loadQueriesCount() {
            const queriesRef = collection(db, 'schedules');
            const q = query(queriesRef, where('status', '==', 'query_raised'));
            
            onSnapshot(q, (snapshot) => {
                const badge = document.getElementById('queryBadge');
                if (badge) {
                    badge.textContent = snapshot.size;
                    badge.style.display = snapshot.size > 0 ? 'inline-block' : 'none';
                }
            });
        }

        // Search users
        document.getElementById('searchUser').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const userItems = document.querySelectorAll('#usersList > div');
            
            userItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Initialize
        loadUsers();
        loadSchedules();
        loadQueriesCount();

        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('scheduleDate').valueAsDate = tomorrow;
        
        // Set default time to next hour
        const nextHour = new Date();
        nextHour.setHours(nextHour.getHours() + 1);
        document.getElementById('startTime').value = nextHour.toTimeString().substring(0, 5);
        nextHour.setHours(nextHour.getHours() + 1);
        document.getElementById('endTime').value = nextHour.toTimeString().substring(0, 5);
    </script>
</body>
</html>
