// Load schedules - UPDATED VERSION
let unsubscribeSchedules;
function loadSchedules() {
    const container = document.getElementById('schedulesContainer');
    const statusFilter = document.getElementById('statusFilter');
    
    if (unsubscribeSchedules) unsubscribeSchedules();
    
    let q = collection(db, 'schedules');
    
    unsubscribeSchedules = onSnapshot(q, (snapshot) => {
        container.innerHTML = '';
        
        if (snapshot.empty) {
            container.innerHTML = '<div class="text-center py-5"><p class="text-muted">No schedules found</p></div>';
            return;
        }
        
        // Group schedules by status for counting
        const statusCounts = {
            all: snapshot.size,
            sent: 0,
            delivered: 0,
            viewed: 0,
            approved: 0,
            query_raised: 0
        };
        
        // Filter and display schedules
        snapshot.docs.forEach((doc) => {
            const schedule = { id: doc.id, ...doc.data() };
            
            // Count by status
            statusCounts[schedule.status]++;
            
            // Apply status filter
            if (statusFilter.value !== 'all' && schedule.status !== statusFilter.value) {
                return;
            }
            
            const scheduleDiv = document.createElement('div');
            scheduleDiv.className = `schedule-card card p-3 mb-3 ${schedule.status === 'approved' ? 'approved' : ''} ${schedule.status === 'query_raised' ? 'query' : ''}`;
            
            // Status icon mapping
            const statusIcons = {
                sent: '‚úîÔ∏è',
                delivered: '‚úîÔ∏è‚úîÔ∏è',
                viewed: 'üîµ',
                approved: '‚úÖ',
                query_raised: '‚ùó'
            };
            
            scheduleDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div style="flex: 1;">
                        <h6>${schedule.subject}</h6>
                        <p class="mb-1"><strong>Class:</strong> ${schedule.className}</p>
                        <p class="mb-1"><strong>Faculty:</strong> ${schedule.facultyName} (${schedule.facultyEmail})</p>
                        <p class="mb-1"><strong>Date:</strong> ${schedule.date} | ${schedule.startTime} - ${schedule.endTime}</p>
                        <p class="mb-0"><strong>Status:</strong> ${statusIcons[schedule.status] || schedule.status}</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${getStatusColor(schedule.status)}">
                            ${schedule.status.replace('_', ' ')}
                        </span>
                        <div class="mt-2 small text-muted">
                            Created: ${new Date(schedule.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                </div>
                ${schedule.queries && schedule.queries.length > 0 ? `
                    <div class="mt-3 border-top pt-3">
                        <h6><i class="bi bi-chat-left-text"></i> Discussion:</h6>
                        <div class="mt-2">
                            ${schedule.queries.map((q, index) => `
                                <div class="query-bubble ${q.sender === 'faculty' ? 'faculty' : 'admin'} mb-2">
                                    <div class="d-flex justify-content-between">
                                        <strong>${q.sender === 'faculty' ? schedule.facultyName : 'You (Admin)'}</strong>
                                        <small class="text-muted">${new Date(q.timestamp).toLocaleString()}</small>
                                    </div>
                                    <div class="mt-1">${q.message}</div>
                                </div>
                            `).join('')}
                        </div>
                        ${schedule.status === 'query_raised' ? `
                            <div class="mt-2">
                                <div class="input-group">
                                    <textarea class="form-control" id="response-${schedule.id}" 
                                              placeholder="Type your response..." rows="2"></textarea>
                                    <button class="btn btn-primary" onclick="sendResponse('${schedule.id}')">
                                        <i class="bi bi-send"></i> Send
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            `;
            
            container.appendChild(scheduleDiv);
        });
        
        // Update dropdown with counts
        updateStatusDropdown(statusCounts);
    });
}

// Helper function for status colors
function getStatusColor(status) {
    const colors = {
        sent: 'secondary',
        delivered: 'info',
        viewed: 'primary',
        approved: 'success',
        query_raised: 'warning'
    };
    return colors[status] || 'secondary';
}

// Update status dropdown with counts
function updateStatusDropdown(counts) {
    const statusFilter = document.getElementById('statusFilter');
    const options = statusFilter.options;
    
    // Update option texts with counts
    options[0].text = `All Schedules (${counts.all})`;
    options[1].text = `Sent (${counts.sent})`;
    options[2].text = `Delivered (${counts.delivered})`;
    options[3].text = `Viewed (${counts.viewed})`;
    options[4].text = `Approved (${counts.approved})`;
    options[5].text = `Queries (${counts.query_raised})`;
}
