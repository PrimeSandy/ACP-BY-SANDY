<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Academic Schedule Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .schedule-status-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .filter-btn:hover:not(.active) {
            background: var(--secondary-bg);
            transform: translateY(-2px);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .query-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-warning), #d97706);
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn glass" id="themeToggle">
            <i class="bi bi-sun-fill"></i>
        </button>
    </div>

    <!-- Navigation -->
    <nav class="navbar glass">
        <div class="container-fluid">
            <a class="navbar-brand gradient-text" href="#">
                <div class="glass-icon" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));">
                    <i class="bi bi-calendar-check text-white"></i>
                </div>
                Admin Dashboard
            </a>
            <div class="d-flex align-items-center gap-3">
                <div class="user-badge glass">
                    <div class="user-avatar me-2">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div>
                        <div class="small" id="adminName">Loading...</div>
                        <div class="badge badge-primary mt-1">ADMIN</div>
                    </div>
                </div>
                <button class="btn btn-outline btn-sm" id="logoutBtn">
                    <i class="bi bi-box-arrow-right me-1"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Notification Area -->
    <div id="notificationArea"></div>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <!-- Stats Overview -->
                <div class="admin-stats">
                    <div class="stats-card glass">
                        <div class="stats-value" id="totalSchedules">0</div>
                        <div class="stats-label">Total Schedules</div>
                    </div>
                    <div class="stats-card glass">
                        <div class="stats-value" id="pendingApprovals">0</div>
                        <div class="stats-label">Pending</div>
                    </div>
                    <div class="stats-card glass">
                        <div class="stats-value" id="facultyCount">0</div>
                        <div class="stats-label">Faculty</div>
                    </div>
                </div>

                <!-- Create Schedule Form -->
                <div class="card glass hover-lift">
                    <div class="card-header">
                        <i class="bi bi-plus-circle gradient-text"></i>
                        Create New Schedule
                    </div>
                    <div class="card-body">
                        <form id="scheduleForm">
                            <div class="mb-3">
                                <label class="form-label">Faculty Email</label>
                                <input type="email" class="form-control glass-light" id="facultyEmail" required 
                                    placeholder="faculty@college.edu">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control glass-light" id="subject" required 
                                    placeholder="e.g., Data Structures">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Class/Group</label>
                                <input type="text" class="form-control glass-light" id="className" required 
                                    placeholder="e.g., CSE-A, 3rd Year">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control glass-light" id="scheduleDate" required>
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <label class="form-label">Start Time</label>
                                    <input type="time" class="form-control glass-light" id="startTime" required>
                                </div>
                                <div class="col">
                                    <label class="form-label">End Time</label>
                                    <input type="time" class="form-control glass-light" id="endTime" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-send me-2"></i> Create & Send Schedule
                            </button>
                        </form>
                    </div>
                </div>

                <!-- User Management -->
                <div class="card glass hover-lift">
                    <div class="card-header">
                        <i class="bi bi-people gradient-text"></i>
                        User Management
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control glass-light" id="searchUser" 
                                placeholder="Search by name or email">
                        </div>
                        <div id="usersList" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <ul class="nav nav-tabs" id="adminTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#allSchedules">
                            <i class="bi bi-list-ul me-2"></i> All Schedules
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#queries">
                            <i class="bi bi-question-circle me-2"></i> Faculty Queries
                            <span class="badge badge-warning ms-1" id="queryBadge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#analytics">
                            <i class="bi bi-bar-chart me-2"></i> Analytics
                        </a>
                    </li>
                </ul>

                <div class="tab-content mt-3">
                    <!-- All Schedules Tab -->
                    <div class="tab-pane fade show active" id="allSchedules">
                        <div class="card glass">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-calendar-week me-2 gradient-text"></i>All Schedules</h5>
                                <select class="form-select form-select-sm glass-light" id="statusFilter" style="width: 180px;">
                                    <option value="all">All Status</option>
                                    <option value="sent">Sent</option>
                                    <option value="delivered">Delivered</option>
                                    <option value="viewed">Viewed</option>
                                    <option value="approved">Approved</option>
                                    <option value="query_raised">Queries</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div id="schedulesContainer">
                                    <div class="text-center py-5">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-3 text-muted">Loading schedules...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Queries Tab -->
                    <div class="tab-pane fade" id="queries">
                        <div class="card glass">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-chat-left-text me-2 gradient-text"></i>Faculty Queries</h5>
                            </div>
                            <div class="card-body">
                                <div id="queriesContainer">
                                    <div class="text-center py-5">
                                        <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-warning), #d97706);">
                                            <i class="bi bi-question-lg text-white"></i>
                                        </div>
                                        <h5 class="mb-2">No pending queries</h5>
                                        <p class="text-muted">All queries have been addressed</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div class="tab-pane fade" id="analytics">
                        <div class="card glass">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-bar-chart me-2 gradient-text"></i>Analytics Dashboard</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card glass-light mb-3">
                                            <div class="card-body">
                                                <h6 class="mb-3">Schedule Status Distribution</h6>
                                                <div id="statusChart"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card glass-light">
                                            <div class="card-body">
                                                <h6 class="mb-3">Recent Activity</h6>
                                                <div id="activityTimeline"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase and Admin JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            onSnapshot, 
            updateDoc, 
            doc, 
            getDoc, 
            setDoc,
            orderBy 
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALXM9g6HkFHuHLYNXjZ417_9d6bkPGatc",
            authDomain: "tracker-pts.firebaseapp.com",
            projectId: "tracker-pts",
            storageBucket: "tracker-pts.firebasestorage.app",
            messagingSenderId: "237919442573",
            appId: "1:237919442573:web:e3abad42a0a1f49f5334c4",
            measurementId: "G-R5K7KNKMYS"
        };

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        const currentTheme = localStorage.getItem('theme') || (prefersDark.matches ? 'dark' : 'light');
        
        if (currentTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            themeIcon.className = 'bi bi-moon-fill';
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            themeIcon.className = 'bi bi-sun-fill';
        }
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (currentTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                themeIcon.className = 'bi bi-moon-fill';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                themeIcon.className = 'bi bi-sun-fill';
            }
        });

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check if user is admin
        if (localStorage.getItem('userRole') !== 'admin') {
            alert('Access denied. Admins only.');
            window.location.href = 'index.html';
        }

        // Set admin name
        const adminName = localStorage.getItem('userName') || 'Admin';
        document.getElementById('adminName').textContent = adminName;

        // Show notification
        function showNotification(message, type = 'info', duration = 5000) {
            const notificationArea = document.getElementById('notificationArea');
            const notificationId = 'notification-' + Date.now();
            
            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = `notification fade-in`;
            notification.innerHTML = `
                <div class="glass-icon" style="background: ${getNotificationColor(type)};">
                    <i class="bi ${getNotificationIcon(type)} text-white"></i>
                </div>
                <div class="flex-grow-1">
                    <p class="mb-0">${message}</p>
                </div>
                <button type="button" class="btn-close" onclick="document.getElementById('${notificationId}').remove()"></button>
            `;
            
            if (!notificationArea) {
                const newNotificationArea = document.createElement('div');
                newNotificationArea.id = 'notificationArea';
                document.body.appendChild(newNotificationArea);
            }
            
            document.getElementById('notificationArea').appendChild(notification);
            
            // Auto remove after duration
            setTimeout(() => {
                const notif = document.getElementById(notificationId);
                if (notif) notif.remove();
            }, duration);
        }

        function getNotificationColor(type) {
            switch(type) {
                case 'success': return 'linear-gradient(135deg, var(--accent-success), #059669)';
                case 'warning': return 'linear-gradient(135deg, var(--accent-warning), #d97706)';
                case 'danger': return 'linear-gradient(135deg, var(--accent-danger), #dc2626)';
                default: return 'linear-gradient(135deg, var(--accent-info), #2563eb)';
            }
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'bi-check-circle-fill';
                case 'warning': return 'bi-exclamation-triangle-fill';
                case 'danger': return 'bi-x-circle-fill';
                default: return 'bi-info-circle-fill';
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Logout error:", error);
                showNotification('Logout failed', 'danger');
            }
        });

        // Load users
        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<div class="text-center py-3"><div class="loading-spinner"></div></div>';
            
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                usersList.innerHTML = '';
                
                if (usersSnapshot.empty) {
                    usersList.innerHTML = '<div class="text-center py-3 text-muted">No users found</div>';
                    return;
                }
                
                let facultyCount = 0;
                usersSnapshot.forEach((userDoc) => {
                    const user = userDoc.data();
                    const userDiv = document.createElement('div');
                    userDiv.className = 'd-flex justify-content-between align-items-center p-3 border-bottom border-light';
                    
                    const userName = user.name || 'No name';
                    const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    
                    userDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-3">
                                ${initials}
                            </div>
                            <div>
                                <strong class="d-block">${userName}</strong>
                                <small class="text-muted d-block">${user.email}</small>
                                <span class="badge ${user.role === 'admin' ? 'badge-primary' : 'badge-success'} mt-1">
                                    ${user.role}
                                </span>
                            </div>
                        </div>
                        <select class="form-select form-select-sm glass-light role-select" data-uid="${userDoc.id}" style="width: 120px;">
                            <option value="faculty" ${user.role === 'faculty' ? 'selected' : ''}>Faculty</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    `;
                    usersList.appendChild(userDiv);
                    
                    if (user.role === 'faculty') facultyCount++;
                });
                
                // Update faculty count
                document.getElementById('facultyCount').textContent = facultyCount;
                
                // Add event listeners to role selects
                document.querySelectorAll('.role-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const uid = e.target.dataset.uid;
                        const newRole = e.target.value;
                        
                        // Prevent removing last admin
                        if (newRole === 'faculty') {
                            const adminUsers = await getDocs(query(collection(db, 'users'), where('role', '==', 'admin')));
                            if (adminUsers.size <= 1) {
                                showNotification('Cannot change role: At least one admin must exist.', 'warning');
                                e.target.value = 'admin';
                                return;
                            }
                        }
                        
                        try {
                            await updateDoc(doc(db, 'users', uid), { role: newRole });
                            showNotification('User role updated successfully', 'success');
                            loadUsers(); // Refresh user list
                        } catch (error) {
                            console.error("Error updating role:", error);
                            showNotification('Failed to update role', 'danger');
                        }
                    });
                });
            } catch (error) {
                console.error("Error loading users:", error);
                usersList.innerHTML = '<div class="text-center py-3 text-danger">Error loading users</div>';
                showNotification('Error loading users: ' + error.message, 'danger');
            }
        }

        // Create schedule
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const facultyEmail = document.getElementById('facultyEmail').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const className = document.getElementById('className').value.trim();
            const scheduleDate = document.getElementById('scheduleDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            // Validation
            if (!facultyEmail || !subject || !className || !scheduleDate || !startTime || !endTime) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            if (startTime >= endTime) {
                showNotification('End time must be after start time', 'warning');
                return;
            }
            
            // Get faculty user by email
            try {
                const usersSnapshot = await getDocs(query(collection(db, 'users'), where('email', '==', facultyEmail)));
                if (usersSnapshot.empty) {
                    showNotification('Faculty not found. Please check the email address.', 'warning');
                    return;
                }
                
                const facultyUser = usersSnapshot.docs[0].data();
                const facultyId = usersSnapshot.docs[0].id;
                
                // Check for duplicate schedule
                const existingSchedules = await getDocs(query(
                    collection(db, 'schedules'),
                    where('facultyId', '==', facultyId),
                    where('date', '==', scheduleDate),
                    where('startTime', '==', startTime)
                ));
                
                if (!existingSchedules.empty) {
                    showNotification('A schedule already exists for this faculty at the same time', 'warning');
                    return;
                }
                
                const scheduleData = {
                    facultyEmail: facultyEmail,
                    facultyName: facultyUser.name,
                    facultyId: facultyId,
                    subject: subject,
                    className: className,
                    date: scheduleDate,
                    startTime: startTime,
                    endTime: endTime,
                    status: 'sent',
                    createdBy: auth.currentUser.uid,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    queries: []
                };
                
                await addDoc(collection(db, 'schedules'), scheduleData);
                
                // Reset form
                document.getElementById('scheduleForm').reset();
                
                // Set default date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('scheduleDate').valueAsDate = tomorrow;
                
                showNotification('Schedule created and sent successfully!', 'success');
                
            } catch (error) {
                console.error("Error creating schedule:", error);
                showNotification('Failed to create schedule: ' + error.message, 'danger');
            }
        });

        // Load schedules
        let unsubscribeSchedules;
        function loadSchedules(filterStatus = 'all') {
            const container = document.getElementById('schedulesContainer');
            
            if (unsubscribeSchedules) unsubscribeSchedules();
            
            // Simple query without orderBy to avoid indexing issues
            let q = collection(db, 'schedules');
            
            unsubscribeSchedules = onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); margin: 0 auto;">
                                <i class="bi bi-calendar-x text-white"></i>
                            </div>
                            <h5 class="mb-2">No schedules found</h5>
                            <p class="text-muted">Create your first schedule to get started</p>
                        </div>
                    `;
                    updateStats(0, 0, 0);
                    return;
                }
                
                // Convert to array and sort manually
                let schedules = [];
                let totalSchedules = 0;
                let pendingApprovals = 0;
                
                snapshot.forEach((doc) => {
                    const schedule = { id: doc.id, ...doc.data() };
                    schedules.push(schedule);
                    totalSchedules++;
                    
                    if (['sent', 'delivered', 'viewed', 'query_raised'].includes(schedule.status)) {
                        pendingApprovals++;
                    }
                });
                
                // Update stats
                updateStats(totalSchedules, pendingApprovals, 0);
                
                // Sort manually by date and time
                schedules.sort((a, b) => {
                    const dateCompare = b.date.localeCompare(a.date);
                    if (dateCompare !== 0) return dateCompare;
                    return b.startTime.localeCompare(a.startTime);
                });
                
                // Apply filter
                if (filterStatus !== 'all') {
                    schedules = schedules.filter(schedule => schedule.status === filterStatus);
                }
                
                if (schedules.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-info), #2563eb); margin: 0 auto;">
                                <i class="bi bi-filter-circle text-white"></i>
                            </div>
                            <h5 class="mb-2">No matching schedules</h5>
                            <p class="text-muted">Try changing your filter criteria</p>
                        </div>
                    `;
                    return;
                }
                
                schedules.forEach((schedule) => {
                    const scheduleDiv = document.createElement('div');
                    scheduleDiv.className = `schedule-card glass fade-in ${schedule.status === 'approved' ? 'approved' : ''} ${schedule.status === 'query_raised' ? 'query' : ''}`;
                    
                    // Status icons
                    const statusIcons = {
                        sent: 'üì§',
                        delivered: 'üì•',
                        viewed: 'üëÅÔ∏è',
                        approved: '‚úÖ',
                        query_raised: '‚ùì'
                    };
                    
                    const statusColors = {
                        sent: 'badge-sent',
                        delivered: 'badge-delivered',
                        viewed: 'badge-viewed',
                        approved: 'badge-approved',
                        query_raised: 'badge-query_raised'
                    };
                    
                    scheduleDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <h6 class="mb-2 gradient-text">${schedule.subject}</h6>
                                <p class="mb-1"><strong>Class:</strong> ${schedule.className}</p>
                                <p class="mb-1"><strong>Faculty:</strong> ${schedule.facultyName} <small class="text-muted">(${schedule.facultyEmail})</small></p>
                                <p class="mb-1"><strong>Date:</strong> ${schedule.date}</p>
                                <p class="mb-1">
                                    <strong>Time:</strong> 
                                    <span class="badge glass-light ms-1">${schedule.startTime} - ${schedule.endTime}</span>
                                </p>
                                <p class="mb-0">
                                    <strong>Status:</strong> 
                                    <span class="badge ${statusColors[schedule.status]} ms-2">
                                        ${statusIcons[schedule.status] || ''} ${schedule.status.replace('_', ' ')}
                                    </span>
                                </p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Created: ${new Date(schedule.createdAt).toLocaleDateString()}</small>
                            </div>
                        </div>
                        ${schedule.queries && schedule.queries.length > 0 ? `
                            <div class="mt-3 border-top pt-3">
                                <h6><i class="bi bi-chat-left-text me-2 gradient-text"></i>Discussion</h6>
                                <div class="mt-2">
                                    ${schedule.queries.map((q, index) => `
                                        <div class="query-bubble ${q.sender === 'faculty' ? 'faculty' : 'admin'} mb-2">
                                            <div class="d-flex justify-content-between mb-1">
                                                <strong>${q.sender === 'faculty' ? schedule.facultyName : 'You (Admin)'}</strong>
                                                <small class="text-muted">${new Date(q.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                                            </div>
                                            <div>${q.message}</div>
                                            <div class="text-end mt-1">
                                                <small class="text-muted">${new Date(q.timestamp).toLocaleDateString()}</small>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${schedule.status === 'query_raised' ? `
                                    <div class="mt-2">
                                        <div class="input-group">
                                            <textarea class="form-control glass-light" id="response-${schedule.id}" 
                                                    placeholder="Type your response..." rows="2"></textarea>
                                            <button class="btn btn-primary" onclick="sendResponse('${schedule.id}')">
                                                <i class="bi bi-send"></i> Reply
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    `;
                    
                    container.appendChild(scheduleDiv);
                });
                
            }, (error) => {
                console.error("Error loading schedules:", error);
                container.innerHTML = `
                    <div class="text-center py-5">
                        <div class="glass-icon mb-3" style="background: linear-gradient(135deg, var(--accent-danger), #dc2626); margin: 0 auto;">
                            <i class="bi bi-exclamation-triangle text-white"></i>
                        </div>
                        <h5 class="mt-3">Error loading schedules</h5>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-primary mt-2" onclick="loadSchedules()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Retry
                        </button>
                    </div>
                `;
            });
        }

        // Update stats
        function updateStats(total, pending, queries) {
            document.getElementById('totalSchedules').textContent = total;
            document.getElementById('pendingApprovals').textContent = pending;
        }

        // Send response to query
        window.sendResponse = async function(scheduleId) {
            const responseText = document.getElementById(`response-${scheduleId}`)?.value?.trim();
            if (!responseText) {
                showNotification('Please enter a response message', 'warning');
                return;
            }
            
            try {
                const scheduleRef = doc(db, 'schedules', scheduleId);
                const scheduleDoc = await getDoc(scheduleRef);
                const schedule = scheduleDoc.data();
                
                const queries = schedule.queries || [];
                queries.push({
                    message: responseText,
                    sender: 'admin',
                    timestamp: new Date().toISOString()
                });
                
                await updateDoc(scheduleRef, {
                    queries: queries,
                    status: 'viewed',
                    updatedAt: new Date().toISOString()
                });
                
                document.getElementById(`response-${scheduleId}`).value = '';
                showNotification('Response sent successfully', 'success');
            } catch (error) {
                console.error("Error sending response:", error);
                showNotification('Failed to send response', 'danger');
            }
        };

        // Load queries count
        function loadQueriesCount() {
            const queriesRef = collection(db, 'schedules');
            const q = query(queriesRef, where('status', '==', 'query_raised'));
            
            onSnapshot(q, (snapshot) => {
                const badge = document.getElementById('queryBadge');
                if (badge) {
                    badge.textContent = snapshot.size;
                    badge.style.display = snapshot.size > 0 ? 'inline-block' : 'none';
                }
            }, (error) => {
                console.error("Error loading queries count:", error);
            });
        }

        // Search users
        document.getElementById('searchUser').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const userItems = document.querySelectorAll('#usersList > div');
            
            userItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Initialize
        loadUsers();
        loadSchedules();
        loadQueriesCount();

        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('scheduleDate').valueAsDate = tomorrow;
        
        // Set default time to next hour
        const nextHour = new Date();
        nextHour.setHours(nextHour.getHours() + 1);
        const startTimeStr = nextHour.toTimeString().substring(0, 5);
        document.getElementById('startTime').value = startTimeStr;
        
        nextHour.setHours(nextHour.getHours() + 1);
        const endTimeStr = nextHour.toTimeString().substring(0, 5);
        document.getElementById('endTime').value = endTimeStr;
    </script>
</body>
</html>
